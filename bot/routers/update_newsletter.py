# -*- coding: UTF-8 -*-

from aiogram.fsm.context import FSMContext
from aiogram.filters import Command
from aiogram.enums import ParseMode
from aiogram.types import Message 
from aiogram import Router, Bot
import logging

from database.mongodb.interaction import Interaction
from data_storage.emojis_chats import *



db = Interaction()
router = Router()
emojis = Emojis()

@router.message(Command(commands=['update']))
async def update_message(message: Message, state: FSMContext, bot: Bot) -> None:
    """
    –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    """
    await state.clear()
    user_ids = await db.get_users_id()
    update_message = """
        –£–≤–∞–∂–∞–µ–º—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ @NBC_HelperBot!

    –•–æ—á—É —Å–æ–æ–±—â–∏—Ç—å –≤–∞–º –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –Ω–∞—à–µ–≥–æ –±–æ—Ç–∞.
    
–ë—ã–ª–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ <b>"üïó–û–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è —Å –±—Ä–æ–Ω—è–º–∏ –ø—Ä–µ–≥–æ–≤–æ—Ä–Ω—ã—Ö –∫–æ–º–Ω–∞—Ç"</b>, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–º–æ—Ç—Ä–µ—Ç—å —Å–ø–∏—Å–æ–∫ –±—Ä–æ–Ω–µ–π –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –≤–∞–º–∏ –ø–µ—Ä–µ–≥–æ–≤–æ—Ä–Ω–æ–π –∫–æ–º–Ω–∞—Ç—ã –∏ –¥–∞—Ç—ã.

–¢–µ–ø–µ—Ä—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–≥–æ–≤–æ—Ä–Ω—ã—Ö –∫–æ–º–Ω–∞—Ç –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è –±–µ–∑ —É—á–∞—Å—Ç–∏—è –Ω–∞—à–µ–≥–æ –∑–∞–º–µ—á–∞—Ç–µ–ª—å–Ω–æ–≥–æ –æ—Ñ–∏—Å –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –ê–ª–µ—Å–∏ –∏ –æ–Ω–∞ –Ω–µ –∏–º–µ–µ—Ç –∫ —ç—Ç–æ–º—É –Ω–∏–∫–∞–∫–æ–≥–æ –æ—Ç–Ω–æ—à–µ–Ω–∏—è. –≠—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ —á—Ç–æ–±—ã —É–º–µ–Ω—å—à–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –ø—Ä–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ –ø–µ—Ä–µ–≥–æ–≤–æ—Ä–Ω—ã—Ö –∫–æ–º–Ω–∞—Ç –∏ —É–±—Ä–∞—Ç—å –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –Ω–µ–¥–æ–ø–æ–Ω–∏–º–∞–Ω–∏–π –º–µ–∂–¥—É —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏.

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ —Å–∏—Ç—É–∞—Ü–∏–∏ –∫–æ–≥–¥–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–ª –ø–µ—Ä–µ–≥–æ–≤–æ—Ä–Ω—É—é –∫–æ–º–Ω–∞—Ç—É —Å –ø–æ–º–æ—â—å—é –±–æ—Ç–∞, –∞ –¥—Ä—É–≥–æ–π –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è –µ–π –∏ –ø–æ–º–µ—à–∞–ª –µ–º—É, —Ö–æ—Ç—è –Ω–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–ª –µ–µ –ø—Ä–∏ –ø–æ–º–æ—â–∏ –±–æ—Ç–∞, –±—É–¥–µ—Ç –ø—Ä–∞–≤ –ø–µ—Ä–≤—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫, –∫–æ—Ç–æ—Ä—ã–π –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è –±–æ—Ç–æ–º.

–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –Ω–µ–¥–æ–ø–æ–Ω–∏–º–∞–Ω–∏–π –∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –ø–æ–ª—å–∑—É–π—Ç–µ—Å—å –≤—Å–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–º –≤–∞–º —Ñ—É–∫–Ω—Ü–∏–æ–Ω–∞–ª–æ–º. –í—ã –º–æ–∂–µ—Ç–µ –Ω–µ —Ç–æ–ª—å–∫–æ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É –∏ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–ø–∏—Å–æ–∫ –±—Ä–æ–Ω–µ–π –Ω–∞ –¥—Ä—É–≥–∏–µ –¥–∞—Ç—ã, –Ω–æ –∏ —É–¥–∞–ª–∏—Ç—å –≤–∞—à—É –±—Ä–æ–Ω—å –µ—Å–ª–∏ –≤—ã –Ω–µ –º–æ–∂–µ—Ç–µ –µ—é –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è.

–ü–æ –ø—Ä–æ—à–µ—Å—Ç–≤–∏–∏ —á–∞—Å–∞ —Å –Ω–∞—á–∞–ª–∞ –≤–∞—à–µ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø–∏—Å—å –æ –±—Ä–æ–Ω–∏ —É–¥–∞–ª—è–µ—Ç—Å—è.

–° —É–≤–∞–∂–µ–Ω–∏–µ–º @velikiy_ss 
    """
    try:
        for user_id in user_ids:
            try:
                await bot.send_message(user_id, update_message, parse_mode=ParseMode.HTML)
                await message.answer(f'Message send success {emojis.SUCCESS} recipient: {user_id}')
            except Exception as e:
                if "chat not found" in str(e):
                    # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É "chat not found"
                    logging.warning(f"Skipping user_id {user_id} due to 'chat not found' error")
                else:
                    logging.error(e)
        await message.answer(f'Update success {emojis.SUCCESS}')
    except Exception as e:
        logging.error(e)

    await state.clear()

